<app-header></app-header>

<div class="page-container">
  <div class="meal-plan-edit-container mat-elevation-z2">
    <!-- Header section -->
    <div class="header-section">
      <button mat-icon-button color="primary" (click)="cancel()" class="back-button" matTooltip="Back to meal plan">
        <mat-icon>arrow_back</mat-icon>
      </button>

      <h2 class="mat-headline-5">Edit Meal Plan</h2>

      <div class="action-buttons">
        <button mat-raised-button color="primary" (click)="saveChanges()" [disabled]="editForm.invalid">
          <mat-icon>save</mat-icon>
          Save Changes
        </button>
        <button mat-button (click)="cancel()">Cancel</button>
      </div>
    </div>

    <!-- Error message -->
    @if (error) {
      <mat-error class="error-container">
        {{ error }}
      </mat-error>
    }

    <!-- Loading state -->
    @if (isLoading) {
      <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <span>Loading meal plan...</span>
      </div>
    }

    <!-- Edit form -->
    @if (mealPlan && !isLoading) {
      <div class="edit-form-container">
        <form [formGroup]="editForm">
          <div class="form-section">
            <h3>Plan Details</h3>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Plan Name</mat-label>
              <input matInput formControlName="name" placeholder="Enter meal plan name">
              @if (editForm.get('name')?.invalid && editForm.get('name')?.touched) {
                <mat-error>Name is required</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Description</mat-label>
              <textarea matInput formControlName="description" placeholder="Add a description" rows="3"></textarea>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Day of Week</mat-label>
              <mat-select formControlName="dayOfWeek">
                <mat-option [value]="null">Any day</mat-option>
                @for (day of dayOptions; track day.value) {
                  <mat-option [value]="day.value">{{ day.label }}</mat-option>
                }
              </mat-select>
              <mat-hint>Assign this meal plan to a specific day</mat-hint>
            </mat-form-field>
          </div>

          <div class="form-section">
            <h3>Meals in This Plan</h3>
            <p class="section-description">Modify meal types below</p>

            <div class="meal-items-list">
              @if (mealPlan.items.length === 0) {
                <div class="no-meals-message">
                  <mat-icon>info</mat-icon>
                  <span>No meals in this plan. Return to detail view and add meals.</span>
                </div>
              } @else {
                @for (item of mealPlan.items; track item.mealId) {
                  <div class="meal-item-card">
                    <div class="meal-image-small">
                      <img [src]="item.mealImage" [alt]="item.mealTitle">
                    </div>

                    <div class="meal-info">
                      <h4 class="meal-title">{{ item.mealTitle }}</h4>
                      <div class="meal-nutrients-small">
                        <span>{{ item.calories }} cal</span>
                        <span>{{ item.protein }} protein</span>
                      </div>
                    </div>

                    <mat-form-field appearance="outline" class="meal-type-select">
                      <mat-label>Meal Type</mat-label>
                      <mat-select [value]="getMealType(item.mealId)" (selectionChange)="updateMealType(item.mealId, $event.value)">
                        @for (type of mealTypes; track type) {
                          <mat-option [value]="type">{{ type | titlecase }}</mat-option>
                        }
                      </mat-select>
                    </mat-form-field>
                  </div>
                }
              }
            </div>
          </div>
        </form>
      </div>
    }
  </div>
</div>
