<app-header></app-header>

<div class="profile-container">
  <div class="profile-content mat-elevation-z2">
    <h2 class="profile-title">Your Health Profile</h2>

    @if (errorMessage; as error) {
      <mat-error class="error-container">
        {{ error }}
      </mat-error>
    }

    @if (isLoading) {
      <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <span>Loading your profile...</span>
      </div>
    } @else {
      <form [formGroup]="healthForm" (submit)="saveHealthData()">
        <div class="form-section">
          <h3>Basic Information</h3>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Height (cm)</mat-label>
              <input matInput type="number" formControlName="height" placeholder="e.g. 175">

              @if (healthForm.get('height')?.hasError('min')) {
                <mat-error>Height must be at least 50 cm</mat-error>
              }
              @if (healthForm.get('height')?.hasError('max')) {
                <mat-error>Height must be less than 300 cm</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Weight (kg)</mat-label>
              <input matInput type="number" formControlName="weight" placeholder="e.g. 70">

              @if (healthForm.get('weight')?.hasError('min')) {
                <mat-error>Weight must be at least 20 kg</mat-error>
              }
              @if (healthForm.get('weight')?.hasError('max')) {
                <mat-error>Weight must be less than 500 kg</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Age</mat-label>
              <input matInput type="number" formControlName="age" placeholder="e.g. 30">

              @if (healthForm.get('age')?.hasError('min')) {
                <mat-error>Age must be at least 13 years</mat-error>
              }
              @if (healthForm.get('age')?.hasError('max')) {
                <mat-error>Age must be less than 120 years</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Gender</mat-label>
              <mat-select formControlName="gender">
                <mat-option value="male">Male</mat-option>
                <mat-option value="female">Female</mat-option>
                <mat-option value="other">Other</mat-option>
              </mat-select>

              @if (healthForm.get('gender')?.invalid) {
                <mat-error>Please select your gender</mat-error>
              }
            </mat-form-field>
          </div>
        </div>

        <div class="form-section">
          <h3>Fitness Information</h3>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Activity Level</mat-label>
            <mat-select formControlName="activityLevel">
              @for (level of activityLevels; track level.value) {
                <mat-option [value]="level.value">{{ level.label }}</mat-option>
              }
            </mat-select>

            @if (healthForm.get('activityLevel')?.invalid) {
              <mat-error>Please select your activity level</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Fitness Goal</mat-label>
            <mat-select formControlName="fitnessGoal">
              @for (goal of fitnessGoals; track goal.value) {
                <mat-option [value]="goal.value">{{ goal.label }}</mat-option>
              }
            </mat-select>

            @if (healthForm.get('fitnessGoal')?.invalid) {
              <mat-error>Please select your fitness goal</mat-error>
            }
          </mat-form-field>
        </div>

        @if (healthForm.get('height')?.value && healthForm.get('weight')?.value) {
          <div class="metrics-section">
            <h3>Your Metrics</h3>

            <div class="metrics-grid">
              <div
                class="metric-card"
                [ngClass]="getBmiCategory(calculateBMI()).toLowerCase().replace(' ', '-')">
                <div class="metric-value">{{ calculateBMI() }}</div>
                <div class="metric-label">BMI</div>
                <div class="metric-category">{{ getBmiCategory(calculateBMI()) }}</div>
              </div>

              <div class="metric-card">
                <div class="metric-value placeholder">
                  {{ hasHealthData ? 'Calculating...' : 'N/A' }}
                </div>
                <div class="metric-label">BMR</div>
                <div class="metric-description">Basal Metabolic Rate (calories/day)</div>
              </div>

              <div class="metric-card">
                <div class="metric-value placeholder">
                  {{ hasHealthData ? 'Calculating...' : 'N/A' }}
                </div>
                <div class="metric-label">TDEE</div>
                <div class="metric-description">Total Daily Energy Expenditure (calories/day)</div>
              </div>
            </div>

            <div class="metrics-info">
              <mat-icon>info</mat-icon>
              <span>
                These calculations are estimates based on your information. BMR and TDEE will be
                calculated and saved when you submit your profile.
              </span>
            </div>
          </div>
        }

        <div class="button-group">
          <button
            type="submit"
            mat-raised-button
            color="primary"
            [disabled]="healthForm.invalid || isLoading">
            {{ hasHealthData ? 'Update Profile' : 'Save Profile' }}
          </button>
          <button type="button" mat-stroked-button (click)="resetForm()">Reset</button>
        </div>
      </form>
    }
  </div>
</div>
